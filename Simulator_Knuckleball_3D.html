<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <title>Knuckleball Visual Simulator - IB Math Tech</title>
    <style>
        body {
            margin: 0;
            overflow: hidden;
            background-color: #000;
            color: white;
            font-family: 'Segoe UI', sans-serif;
        }

        #overlay {
            position: absolute;
            top: 20px;
            left: 20px;
            pointer-events: none;
            z-index: 100;
        }

        h1 {
            font-size: 24px;
            margin: 0 0 10px 0;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.8);
            background: linear-gradient(90deg, #4CAF50, #2196F3);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        #panel {
            pointer-events: auto;
            background: rgba(16, 20, 24, 0.95);
            padding: 20px;
            border-radius: 12px;
            border: 1px solid #333;
            width: 340px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(10px);
        }

        .scenario-btn {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 90%;
            padding: 10px;
            margin-bottom: 6px;
            background: #2a2a2a;
            border: 1px solid #444;
            color: #ddd;
            cursor: pointer;
            border-radius: 6px;
            transition: all 0.2s;
            font-size: 13px;
        }

        .scenario-btn:hover {
            background: #3a3a3a;
            transform: translateX(5px);
        }

        .scenario-btn.active {
            background: #1565C0;
            border-color: #42A5F5;
            color: white;
            font-weight: bold;
        }

        #stats-panel {
            margin-top: 15px;
            padding-top: 10px;
            border-top: 1px solid #444;
            font-size: 13px;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
        }

        .stat-box {
            background: #000;
            padding: 6px;
            border-radius: 4px;
            text-align: center;
        }

        .stat-label {
            color: #888;
            font-size: 10px;
            text-transform: uppercase;
        }

        .stat-val {
            color: #fff;
            font-weight: bold;
            font-size: 13px;
        }

        .knuckle-tag {
            background: #FF5722;
            color: white;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 10px;
            margin-left: 8px;
            display: none;
        }

        .active .knuckle-tag {
            display: inline-block;
        }

        #action-panel {
            margin-top: 15px;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        button.action-btn {
            padding: 12px;
            border: none;
            border-radius: 6px;
            font-weight: bold;
            cursor: pointer;
            text-transform: uppercase;
            font-size: 14px;
            transition: transform 0.1s;
        }

        button.action-btn:active {
            transform: scale(0.98);
        }

        #shoot-btn {
            background: #4CAF50;
            color: white;
            box-shadow: 0 4px 0 #2E7D32;
        }

        #shoot-btn:hover {
            background: #66BB6A;
        }

        #replay-btn {
            background: #FF9800;
            color: white;
            box-shadow: 0 4px 0 #EF6C00;
            display: none;
        }

        #replay-btn:hover {
            background: #FFB74D;
        }

        #reset-btn {
            background: #333;
            color: #aaa;
            font-size: 11px;
            padding: 8px;
        }

        #reset-btn:hover {
            background: #444;
            color: white;
        }

        #camera-hint {
            position: absolute;
            bottom: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.6);
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 12px;
            color: #aaa;
            pointer-events: none;
        }
    </style>
    <!-- MÃ³dulos Three.js -->
    <script async src="https://unpkg.com/es-module-shims@1.6.3/dist/es-module-shims.js"></script>
    <script type="importmap">
      {
        "imports": {
          "three": "https://unpkg.com/three@0.150.1/build/three.module.js",
          "three/addons/": "https://unpkg.com/three@0.150.1/examples/jsm/"
        }
      }
    </script>
</head>

<body>

    <div id="overlay">
        <h1>Simulador Knuckleball</h1>
        <div id="panel">
            <div style="margin-bottom: 5px; color: #888; font-size: 11px;">1. SELECCIONA ESCENARIO (Tabla 4)</div>
            <div id="scenarios-list"></div>

            <div id="stats-panel">
                <div class="stat-box">
                    <div class="stat-label">Reynolds</div>
                    <div class="stat-val" id="disp-re">-</div>
                </div>
                <div class="stat-box">
                    <div class="stat-label">DesviaciÃ³n</div>
                    <div class="stat-val" id="disp-dev" style="color: #2196F3">-</div>
                </div>
            </div>

            <div id="action-panel">
                <button id="shoot-btn" class="action-btn">âš½ DISPARAR</button>
                <button id="replay-btn" class="action-btn">ðŸ”„ REPETICIÃ“N (Slow)</button>
                <button id="reset-btn" class="action-btn">Limpiar / Reset</button>
            </div>
        </div>
    </div>

    <div id="camera-hint">ï¿½ Afterimages activados para visualizar trayectoria</div>

    <script type="module">
        import * as THREE from 'three';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';

        // --- DATOS TABLA 4 ---
        const TABLE_DATA = [
            { v: 20, re: "2.93e5", cd: 0.31, dev: 0.12, label: "20 m/s (Lento)" },
            { v: 24, re: "3.52e5", cd: 0.20, dev: 0.38, label: "24 m/s" },
            { v: 26, re: "3.81e5", cd: 0.16, dev: 0.62, label: "26 m/s" },
            { v: 28, re: "4.11e5", cd: 0.13, dev: 0.89, label: "28 m/s (Ã“PTIMO)", isOptimal: true },
            { v: 30, re: "4.40e5", cd: 0.12, dev: 0.74, label: "30 m/s" },
            { v: 33, re: "4.84e5", cd: 0.12, dev: 0.51, label: "33 m/s" },
            { v: 35, re: "5.13e5", cd: 0.12, dev: 0.35, label: "35 m/s (RÃ¡pido)" }
        ];

        let currentScenario = TABLE_DATA[3];
        let ghosts = []; // Array para los Afterimages
        const groupGhosts = new THREE.Group();

        // --- UI SETUP ---
        const listContainer = document.getElementById('scenarios-list');
        TABLE_DATA.forEach((data, index) => {
            const btn = document.createElement('div');
            btn.className = `scenario-btn ${data.isOptimal ? 'active' : ''}`;
            btn.innerHTML = `<span>${index + 1}. ${data.label} ${data.isOptimal ? '<span class="knuckle-tag">â˜…</span>' : ''}</span>`;
            btn.onclick = () => selectScenario(data, btn);
            listContainer.appendChild(btn);
        });

        function selectScenario(data, element) {
            currentScenario = data;
            document.querySelectorAll('.scenario-btn').forEach(b => b.classList.remove('active'));
            element.classList.add('active');
            document.getElementById('disp-re').innerText = data.re;
            document.getElementById('disp-dev').innerText = data.dev + " m";
            resetSimulation();
        }

        // --- THREE.JS SETUP ---
        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0x050505);
        scene.fog = new THREE.Fog(0x050505, 10, 50);
        scene.add(groupGhosts);

        const camera = new THREE.PerspectiveCamera(50, window.innerWidth / window.innerHeight, 0.1, 100);
        camera.position.set(-6, 2.5, 0);

        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.shadowMap.enabled = true;
        document.body.appendChild(renderer.domElement);

        const controls = new OrbitControls(camera, renderer.domElement);
        controls.enableDamping = true;

        // Lights
        scene.add(new THREE.AmbientLight(0xffffff, 0.4));
        const spot = new THREE.SpotLight(0xffffff, 1);
        spot.position.set(-5, 10, 5);
        spot.castShadow = true;
        scene.add(spot);

        // Environment
        const field = new THREE.Mesh(new THREE.PlaneGeometry(60, 40), new THREE.MeshStandardMaterial({ color: 0x112211 }));
        field.rotation.x = -Math.PI / 2; field.receiveShadow = true; scene.add(field);

        // Grid
        const grid = new THREE.GridHelper(60, 60, 0x333333, 0x111111);
        grid.position.y = 0.01; scene.add(grid);

        // Goal (Simplified) - SIN BARRERA
        const goal = new THREE.Group(); goal.position.set(25, 0, 0); scene.add(goal);
        const postMat = new THREE.MeshStandardMaterial({ color: 0xeeeeee });
        const p1 = new THREE.Mesh(new THREE.CylinderGeometry(0.06, 0.06, 2.44), postMat); p1.position.set(0, 1.22, -3.66);
        const p2 = new THREE.Mesh(new THREE.CylinderGeometry(0.06, 0.06, 2.44), postMat); p2.position.set(0, 1.22, 3.66);
        const bar = new THREE.Mesh(new THREE.CylinderGeometry(0.06, 0.06, 7.32), postMat); bar.rotation.z = Math.PI / 2; bar.position.set(0, 2.44, 0);
        goal.add(p1, p2, bar);

        // Ball
        const ballGeo = new THREE.IcosahedronGeometry(0.11, 2);
        const ballMat = new THREE.MeshStandardMaterial({ color: 0xffffff });
        const ball = new THREE.Mesh(ballGeo, ballMat);
        ball.position.set(0, 0.11, 0); ball.castShadow = true; scene.add(ball);

        // --- SIMULATION LOGIC ---
        let isSimulating = false;
        let simData = [];
        let frame = 0;
        let speedMultiplier = 1;

        function resetSimulation() {
            isSimulating = false;
            frame = 0;
            ball.position.set(0, 0.11, 0);

            // Clear ghosts
            while (groupGhosts.children.length > 0) {
                groupGhosts.remove(groupGhosts.children[0]);
            }

            camera.position.set(-6, 2.5, 0);
            controls.target.set(5, 1, 0);

            document.getElementById('shoot-btn').style.display = 'block';
            document.getElementById('replay-btn').style.display = 'none';
        }

        function spawnGhost(pos) {
            const ghost = new THREE.Mesh(
                ballGeo,
                new THREE.MeshBasicMaterial({ color: 0xffffff, transparent: true, opacity: 0.3 })
            );
            ghost.position.copy(pos);
            groupGhosts.add(ghost);
        }

        function runSimulation(slowMo = false) {
            resetSimulation();
            speedMultiplier = slowMo ? 0.6 : 1;

            // Generate Path
            simData = [];
            const steps = 150;
            const v0 = currentScenario.v;
            const dev = currentScenario.dev;

            for (let i = 0; i <= steps; i++) {
                const t = i * 0.016;
                const progress = i / steps;
                const x = v0 * t;
                let y = 0.11 + (v0 * 0.12) * t - 4.9 * t * t; if (y < 0.11) y = 0.11;

                // Efecto Knuckleball
                let z = 0;
                if (x > 5) {
                    const wobble = Math.sin(t * 15) + Math.cos(t * 9);
                    z = (dev / 1.5) * wobble * Math.pow(x / 25, 1.5);
                }

                simData.push(new THREE.Vector3(x, y, z));
                if (x >= 25.5) break;
            }

            isSimulating = true;
            document.getElementById('shoot-btn').style.display = 'none';
        }

        function animate() {
            requestAnimationFrame(animate);

            if (isSimulating) {
                // Control velocidad
                if (Math.random() < speedMultiplier) {
                    if (frame < simData.length) {
                        const pos = simData[frame];
                        ball.position.copy(pos);

                        // Spawn Afterimage cada 5 frames
                        if (frame % 5 === 0) spawnGhost(pos);

                        // Camera follow
                        camera.position.x += (pos.x - 6 - camera.position.x) * 0.1;
                        controls.target.lerp(pos, 0.1);

                        frame++;
                    } else {
                        isSimulating = false;
                        document.getElementById('replay-btn').style.display = 'block';
                        document.getElementById('shoot-btn').style.display = 'block';
                        document.getElementById('shoot-btn').innerHTML = "Disparar Nuevo";
                    }
                }
            }

            controls.update();
            renderer.render(scene, camera);
        }

        animate();

        // Listeners
        document.getElementById('shoot-btn').onclick = () => runSimulation(false);
        document.getElementById('replay-btn').onclick = () => runSimulation(true); // Slow mo
        document.getElementById('reset-btn').onclick = resetSimulation;

        // Init
        selectScenario(TABLE_DATA[3], document.querySelectorAll('.scenario-btn')[3]);

        window.onresize = () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        };
    </script>
</body>

</html>